<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Title</title>
    <!-- Link your CSS file -->
    <link rel="stylesheet" href={{ url_for('static', filename='RegistreLogin.css') }}>
</head>
<body>
    <div id="app" v-cloak>

        <div class="actions">
            <button :class='[{ active: isDisabled("register") }]'
                    @click.prevent='setComponent("register")'>Register
            </button> 
            <button :class='[{ active: isDisabled("signin") }]'
                    @click.prevent='setComponent("signin")'>Sign in
            </button>
        </div>

        <transition name='form' mode='out-in'>
            <keep-alive>
                <component :feedback='feedback' :is="currentComponent"
                @register-form='handleForm' @signin-form='handleForm'></component>
            </keep-alive>
        </transition>

    </div>

    <!-- Register Template -->
    <template id="registerTemplate">
        <form @submit.prevent='onSubmit' ref='form' action="" class='register-form'>
            <h2>Register</h2>
            <div class="form-group" >
                <label for="firstname">Name</label>
                <input required type="text" v-model.trim='user.firstname' id='firstname' placeholder="Prénom">
            </div>
            <div class="form-group">
                <label for="lastname">Phone</label>
                <input required type="text" v-model.trim='user.lastname' id='lastname' placeholder="enter your phone number">
            </div>
            <div class="form-group">
                <label for="email">Email</label>
                <input required type="email" v-model.trim='user.email' id='email' placeholder="exemple@gmail.com">
            </div>
            <div class="form-group">
                <label for="address">Adresse</label>
                <input required type="text" v-model.trim='user.address' id='address' placeholder="Adresse">
            </div>
            <div class="form-group">
                <label for="profile">Profile</label>
                <div class="select-wrapper">
                    <span class="placeholder" v-show="!user.profile">Select your matched profile</span>
                    <select required v-model='user.profile' id='profile'>
                        <option value="Admin">Admin</option>
                        <option value="Manager">Manager</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input required type="Password" v-model='user.password' placeholder="Password" id='password'>
            </div>
            <div class="form-group">
                <label for="passwordcheck">Retype password</label>
                <input required type="password" v-model='user.passwordChck' placeholder="Confirme your password" id='passwordcheck'>
            </div>
            <input type="submit" :disabled='!isFormValid' value='Register'>
        </form>
    </template>

    <!-- Signin Template -->
    <template id="signinTemplate">
        <form ref='form' @submit.prevent='handleForm' action="" class='signin-form'>
            <h2>Sign in</h2>
            <div class="form-group">
                <label for="email">Email </label>
                <input required v-model='user.email' type="email" id='email' placeholder="exemple@gmail.com">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input required v-model='user.password' type="password" id='password' placeholder="enter your password">
            </div>
            <div class="form-group">
                <label for="profile">Profile</label>
                <div class="select-wrapper">
                    <span class="placeholder" v-show="!user.profile">Select your matched profile</span>
                    <select required v-model='user.profile' id='profile'>
                        <option value="Admin">Admin</option>
                        <option value="Manager">Manager</option>
                    </select>
                </div>
            </div>
            <input :disabled='!isFormValid' type="submit" value="Sign in">
        </form>
    </template>

    <!-- Feedback Template -->
    <template id="feedbackTemplate">
        <div class="feedback">
            <header>
                <h2>{{ title }}</h2>
            </header>
            <div v-if='feedback.type === "register"'>
                <p>Welcome, <strong>{{ feedback.data.firstname }}</strong>! <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M7.03 4.95L3.5 8.5c-3.33 3.31-3.33 8.69 0 12s8.69 3.33 12 0l6-6c1-.97 1-2.56 0-3.54c-.1-.12-.23-.23-.37-.32l.37-.39c1-.97 1-2.56 0-3.54c-.14-.16-.33-.3-.5-.41c.38-.92.21-2.02-.54-2.77c-.87-.87-2.22-.96-3.2-.28a2.517 2.517 0 0 0-3.88-.42l-2.51 2.51c-.09-.14-.2-.27-.32-.39a2.53 2.53 0 0 0-3.52 0m1.41 1.42c.2-.2.51-.2.71 0s.2.51 0 .71l-3.18 3.18a3 3 0 0 1 0 4.24l1.41 1.41a5 5 0 0 0 1.12-5.36l6.3-6.3c.2-.2.51-.2.7 0s.21.51 0 .71l-4.59 4.6l1.41 1.41l6.01-6.01c.2-.2.51-.2.71 0s.2.51 0 .71l-6.01 6.01l1.41 1.41l4.95-4.95c.2-.2.51-.2.71 0s.2.51 0 .71l-5.66 5.65l1.41 1.42l3.54-3.54c.2-.2.51-.2.71 0s.2.51 0 .71l-6 6.01c-2.54 2.54-6.65 2.54-9.19 0s-2.54-6.65 0-9.19zM23 17c0 3.31-2.69 6-6 6v-1.5c2.5 0 4.5-2 4.5-4.5zM1 7c0-3.31 2.69-6 6-6v1.5c-2.5 0-4.5 2-4.5 4.5z"/></svg></p>
            </div>
            <div v-else>
                <p>Vous allez être redirigé(e) dans quelques instants...</p>
            </div>
        </div>
    </template>

    <!-- JavaScript Code -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script>
        const emailRegex = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/

        const registerComponent = {
            template:'#registerTemplate',
            name:'RegisterComponent',
            data () {
                return { 
                    user : {
                        firstname:'',
                        lastname:'',
                        email:'',
                        address:'',
                        profile:'',
                        password:'',
                        passwordChck:''
                    }
                }
            },
            computed: {
                isFormValid () {
                    return (
                        this.isValid('firstname') && 
                        this.isValid('lastname') && 
                        this.isValid('email') && 
                        this.isValid('address') &&
                        this.isValid('profile') &&
                        this.isValid('password') && 
                        this.isValid('passwordChck')
                    )
                }
            },
            methods: {
                isValid(prop) {
                    switch (prop) {
                        case 'firstname':
                            return this.user.firstname.length >= 2
                            break
                        case 'lastname':
                            return this.user.lastname.length >= 2
                            break
                        case 'email':
                            return emailRegex.test(this.user.email)
                            break
                        case 'address':
                            return this.user.address.length >= 2
                            break
                        case 'password':
                            return this.user.password.length >= 6
                            break
                        case "passwordChck":
                            return this.user.password === this.user.passwordChck
                            break
                        case "profile":
                            return !!this.user.profile // Check if profile is selected
                        default:
                            return false
                    }
                },
                resetUser () {
                    this.user.firstname = ''
                    this.user.lastname = ''
                    this.user.email = ''
                    this.user.address = ''
                    this.user.profile = ''
                    this.user.password = ''
                    this.user.passwordChck = ''
                 
                },
                onSubmit () {
                    let user = Object.assign({}, this.user)
                    this.resetUser()
                    this.$emit('register-form', {type:'register', data:user})
                }
            },
            mounted () {
                let element = this.$el.querySelector('#passwordcheck')
                element.addEventListener('blur', () => {
                    if (!this.isValid('passwordChck')) {
                        element.classList.add('invalid')
                    } else {
                        element.classList.remove('invalid')
                    }
                })  
            }
        }

        const signInComponent = {
            template:'#signinTemplate',
            name:'SigninComponent',
            data () {
                return { 
                    user: {
                        email:'',
                        password:''
                    }
                }
            },
            methods: {
                handleForm () {
                    let formvalue = Object.assign({}, this.user)
                    this.resetFormValues()
                    this.$emit('signin-form', {type:'signin', data:formvalue})
                    window.location.href = '/' //send Dashboard
                },
                resetFormValues () {
                    this.user.email = ''
                    this.user.password = ''
                },
                isValid(prop) {
                    switch(prop) {
                        case 'email':
                            return emailRegex.test(this.user.email)
                            break
                        case 'password':
                            return this.user.password.length >= 6
                            break
                        default:
                            return false
                    }
                },
            },
            computed: {
                isFormValid () {
                    return (this.isValid('email') && this.isValid('password'))
                }
            }
        }

        const feedbackComponent = {
            template:'#feedbackTemplate',
            name:"FeedbackComponent",
            filters: {
                email (input) {
                    if (input.email) {
                        return input.email
                    } else {
                        return ''
                    }
                },
                name (input) {
                    return input.firstname ? input.firstname : ''
                }
            },
            data () { return {} },
            props:['feedback'],
            computed: {
                title () {
                    return this.feedback.type === 'signin' ?
                        'Authentification done' : 'Registerd successfully'
                }
            }
        }

        const app = new Vue({
            el:'#app',
            components:{
                register:registerComponent,
                signin:signInComponent,
                feedback:feedbackComponent
            },
            name:'application',
            data () {
                return {
                    feedback:{},
                    currentComponent:'signin'
                }
            },
            methods: {
                handleForm ( data ) {
                    this.feedback = data
                    setTimeout(() => {
                        this.setComponent('feedback')
                    }, 280)
                },
                isDisabled (btnName) {
                    return (this.currentComponent === btnName)
                },
                setComponent(componentName) {
                    if (this.currentComponent !== componentName) {
                        this.currentComponent = componentName
                    }
                }
            }
        })
    </script>
</body>
</html>